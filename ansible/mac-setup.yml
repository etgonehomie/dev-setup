---
- name: Setup mac configuration settings
  hosts: localhost
  vars_files:
    - vars.yml    # relative path to current playbook
  vars:
    mac_config_dir: "{{ root_dir }}/ansible/macos_config_backup"
  tasks:
    - name: Find all .txt files in mac-backup-config directory
      ansible.builtin.find:
        paths: "{{ mac_config_dir }}"
        patterns: "*.plist"
        recurse: no
      register: config_files

    - name: Debug found files
      ansible.builtin.debug:
        var: config_files
      after: "Find all .plist files in mac-backup-config directory"

    # - name: Move .plist files to /Users/john/test
    #   ansible.builtin.copy:
    #     src: "{{ item.path }}"
    #     dest: "{{ ansible_env.HOME }}/test/{{ item.path | basename }}"
    #     remote_src: yes
    #     force: yes
    #   loop: "{{ config_files.files }}"
    
    # # plutil -convert xml1 -o "{{ ansible_env.HOME }}/Library/Preferences/{{ item.path | basename | replace('_', '.') | regex_replace('\\.txt$', '.plist') }}" "{{ item.path }}"
    # - name: Convert and copy each .txt file to .plist in Preferences to replace existing
    #   ansible.builtin.shell: |
    #     plutil \
    #       -convert xml1 \
    #       -o "{{ ansible_env.HOME }}/test/{{ item.path }}
    #       "{{ item.path }}"
    #   register: convert_result
    #   changed_when: convert_result.rc == 0  # Mark as changed if successful

    # - name: Restart affected apps to apply changes
    #   ansible.builtin.shell: "killall {{ item }}"
    #   loop:
    #     - "Dock"
    #     - "Finder"
    #     - "Terminal"
    #     - "Raycast"
    #   ignore_errors: yes  # Ignore if app isnâ€™t running